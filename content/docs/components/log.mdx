---
title: æ—¥å¿—ç³»ç»Ÿ
description: åŸºäº slog çš„è‡ªå®šä¹‰æ—¥å¿— Handler
icon: FileText
---

# æ—¥å¿—ç³»ç»Ÿ

Bamboo Base åŸºäº Go 1.21+ çš„ `slog` åŒ…å®ç°äº†è‡ªå®šä¹‰æ—¥å¿—ç³»ç»Ÿï¼Œæ”¯æŒå½©è‰²æ§åˆ¶å°è¾“å‡ºå’Œ JSON æ–‡ä»¶è®°å½•ã€‚

## ç‰¹æ€§

- ğŸ¨ **å½©è‰²æ§åˆ¶å°è¾“å‡º** - ä¸åŒçº§åˆ«æ˜¾ç¤ºä¸åŒé¢œè‰²
- ğŸ“„ **JSON æ–‡ä»¶è®°å½•** - ç»“æ„åŒ–æ—¥å¿—ä¾¿äºåˆ†æ
- ğŸ” **Trace ID è‡ªåŠ¨æå–** - ä»ä¸Šä¸‹æ–‡æå–è¯·æ±‚è¿½è¸ª ID
- âš¡ **é«˜æ€§èƒ½** - åŸºäº slog çš„é«˜æ€§èƒ½è®¾è®¡

## æ—¥å¿—çº§åˆ«

```go
const (
    LevelDebug slog.Level = -4
    LevelInfo  slog.Level = 0
    LevelWarn  slog.Level = 4
    LevelError slog.Level = 8
)
```

## åˆå§‹åŒ–æ—¥å¿—

```go
func (r *Reg) LoggerInit() {
    // æ§åˆ¶å°å¤„ç†å™¨ï¼ˆå½©è‰²ï¼‰
    consoleHandler := NewColorHandler(os.Stdout, &slog.HandlerOptions{
        Level: slog.LevelInfo,
    })

    // æ–‡ä»¶å¤„ç†å™¨ï¼ˆJSONï¼‰
    logFile := filepath.Join(r.Config.GetString("LOG_PATH"), "app.log")
    file, _ := os.OpenFile(logFile, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0666)
    fileHandler := slog.NewJSONHandler(file, &slog.HandlerOptions{
        Level: slog.LevelInfo,
    })

    // å¤šè¾“å‡ºå¤„ç†å™¨
    r.Logger = slog.New(NewMultiHandler(consoleHandler, fileHandler))
}
```

## å½©è‰²è¾“å‡º

æ§åˆ¶å°è¾“å‡ºæ ¹æ®æ—¥å¿—çº§åˆ«æ˜¾ç¤ºä¸åŒé¢œè‰²ï¼š

| çº§åˆ« | é¢œè‰² | ç¤ºä¾‹ |
|------|------|------|
| DEBUG | ç°è‰² | `[DBG]` |
| INFO | ç»¿è‰² | `[INF]` |
| WARN | é»„è‰² | `[WRN]` |
| ERROR | çº¢è‰² | `[ERR]` |

è¾“å‡ºæ ¼å¼ï¼š

```
[INF] 2024-01-01 12:00:00 | server started | port=8080
[ERR] 2024-01-01 12:00:01 | database error | err=connection refused
```

## ä½¿ç”¨æ—¥å¿—

### åŸºæœ¬ç”¨æ³•

```go
// è®°å½•ä¿¡æ¯
web.Register.Logger.Info("server started", "port", 8080)

// è®°å½•é”™è¯¯
web.Register.Logger.Error("database connection failed", "err", err)

// è®°å½•è­¦å‘Š
web.Register.Logger.Warn("high memory usage", "percent", 85)

// è°ƒè¯•æ—¥å¿—
web.Register.Logger.Debug("processing request", "path", c.Request.URL.Path)
```

### å¸¦ Trace ID çš„æ—¥å¿—

```go
func Handler(c *gin.Context) {
    // ä»ä¸Šä¸‹æ–‡è·å– Trace ID
    traceID := ctxutil.GetTraceID(c)

    // åˆ›å»ºå¸¦ Trace ID çš„ Logger
    logger := web.Register.Logger.With("trace_id", traceID)

    logger.Info("request started", "path", c.Request.URL.Path)

    // å¤„ç†è¯·æ±‚...

    logger.Info("request completed", "duration", time.Since(start))
}
```

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

```bash
# æ—¥å¿—çº§åˆ«: debug, info, warn, error
LOG_LEVEL=info

# æ—¥å¿—æ–‡ä»¶è·¯å¾„
LOG_PATH=./logs

# æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°
LOG_CONSOLE=true

# æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶
LOG_FILE=true
```

### åŠ¨æ€è°ƒæ•´çº§åˆ«

```go
// æ ¹æ®é…ç½®è®¾ç½®æ—¥å¿—çº§åˆ«
level := web.Register.Config.GetString("LOG_LEVEL")
switch level {
case "debug":
    slog.SetLogLoggerLevel(slog.LevelDebug)
case "warn":
    slog.SetLogLoggerLevel(slog.LevelWarn)
case "error":
    slog.SetLogLoggerLevel(slog.LevelError)
default:
    slog.SetLogLoggerLevel(slog.LevelInfo)
}
```

## è‡ªå®šä¹‰ Handler

### ColorHandler

```go
type ColorHandler struct {
    handler slog.Handler
    level   slog.Level
}

func NewColorHandler(w io.Writer, opts *slog.HandlerOptions) *ColorHandler {
    return &ColorHandler{
        handler: slog.NewTextHandler(w, opts),
        level:   opts.Level,
    }
}

func (h *ColorHandler) Handle(ctx context.Context, r slog.Record) error {
    // æ·»åŠ é¢œè‰²ä»£ç 
    var color string
    switch r.Level {
    case slog.LevelDebug:
        color = "\033[37m" // ç°è‰²
    case slog.LevelInfo:
        color = "\033[32m" // ç»¿è‰²
    case slog.LevelWarn:
        color = "\033[33m" // é»„è‰²
    case slog.LevelError:
        color = "\033[31m" // çº¢è‰²
    }
    reset := "\033[0m"

    // è¾“å‡ºå¸¦é¢œè‰²çš„æ—¥å¿—
    fmt.Fprintf(os.Stdout, "%s[%s]%s ", color, r.Level.String(), reset)
    return h.handler.Handle(ctx, r)
}
```

### MultiHandler

åŒæ—¶è¾“å‡ºåˆ°å¤šä¸ªç›®æ ‡ï¼š

```go
type MultiHandler struct {
    handlers []slog.Handler
}

func NewMultiHandler(handlers ...slog.Handler) *MultiHandler {
    return &MultiHandler{handlers: handlers}
}

func (h *MultiHandler) Handle(ctx context.Context, r slog.Record) error {
    for _, handler := range h.handlers {
        if err := handler.Handle(ctx, r); err != nil {
            return err
        }
    }
    return nil
}
```

## å®Œæ•´ç¤ºä¾‹

```go
package main

import (
    "github.com/bamboo-services/bamboo-base-go/web"
    "github.com/gin-gonic/gin"
)

func main() {
    // åˆå§‹åŒ–
    web.InitRegister()
    web.Register.ConfigInit()
    web.Register.LoggerInit()
    web.Register.EngineInit()

    // ä½¿ç”¨æ—¥å¿—
    web.Register.Logger.Info("application starting...")

    web.Register.Engine.GET("/ping", func(c *gin.Context) {
        web.Register.Logger.Debug("ping received", "ip", c.ClientIP())
        c.String(200, "pong")
    })

    web.Register.Logger.Info("server started", "port", 8080)
    web.Register.Run(":8080")
}
```

## ä¸‹ä¸€æ­¥

<Cards>
  <Card title="ä¸­é—´ä»¶" href="./middleware" />
  <Card title="æ³¨å†Œç³»ç»Ÿ" href="./register" />
  <Card title="ç¯å¢ƒé…ç½®" href="./env" />
</Cards>
