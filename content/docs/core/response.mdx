---
title: 统一响应
description: BaseResponse 结构体与响应中间件使用指南
icon: ArrowLeftRight
---

# 统一响应

Bamboo Base 提供统一的 API 响应格式，确保前后端交互的一致性。

## BaseResponse 结构体

```go
type BaseResponse struct {
    // 响应代码
    Code int `json:"code"`

    // 响应消息
    Message string `json:"message"`

    // 响应数据（可选）
    Data interface{} `json:"data,omitempty"`

    // 时间戳
    Timestamp int64 `json:"timestamp"`

    // 请求 ID（用于追踪）
    RequestID string `json:"requestId,omitempty"`
}
```

## 响应格式规范

### 成功响应（无数据）

```json
{
  "code": 200,
  "message": "success",
  "timestamp": 1640995200000
}
```

### 成功响应（有数据）

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "bamboo"
  },
  "timestamp": 1640995200000
}
```

### 错误响应

```json
{
  "code": 400001,
  "message": "参数错误：用户名不能为空",
  "timestamp": 1640995200000,
  "requestId": "req_abc123"
}
```

## result 包使用

`result` 包提供便捷的响应函数：

### Success - 成功（无数据）

```go
func Success(c *gin.Context, message string)
```

示例：

```go
r.POST("/logout", func(c *gin.Context) {
    // 执行登出逻辑
    result.Success(c, "登出成功")
})
```

响应：

```json
{
  "code": 200,
  "message": "登出成功",
  "timestamp": 1640995200000
}
```

### SuccessHasData - 成功（有数据）

```go
func SuccessHasData(c *gin.Context, data interface{})
```

示例：

```go
r.GET("/user/:id", func(c *gin.Context) {
    user := User{
        ID:   1,
        Name: "Bamboo",
    }
    result.SuccessHasData(c, user)
})
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "Bamboo"
  },
  "timestamp": 1640995200000
}
```

### Error - 错误响应

```go
func Error(c *gin.Context, err error)
```

示例：

```go
r.GET("/user/:id", func(c *gin.Context) {
    user, err := getUser(c.Param("id"))
    if err != nil {
        result.Error(c, err)
        return
    }
    result.SuccessHasData(c, user)
})
```

## 响应中间件

`ResponseMiddleware` 自动处理响应格式：

```go
func ResponseMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 包装响应写入器
        blw := &bodyLogWriter{
            body:           bytes.NewBufferString(""),
            ResponseWriter: c.Writer,
        }
        c.Writer = blw

        c.Next()

        // 如果响应已被写入，跳过
        if blw.body.Len() > 0 {
            return
        }

        // 检查是否有错误
        if len(c.Errors) > 0 {
            err := c.Errors.Last().Err
            // 转换为统一错误响应
            c.JSON(200, BaseResponse{
                Code:      getErrorCode(err),
                Message:   err.Error(),
                Timestamp: time.Now().UnixMilli(),
            })
        }
    }
}
```

## 自定义响应

### 创建自定义响应

```go
func CustomResponse(c *gin.Context, code int, message string, data interface{}) {
    c.JSON(200, BaseResponse{
        Code:      code,
        Message:   message,
        Data:      data,
        Timestamp: time.Now().UnixMilli(),
    })
}
```

### 分页响应

```go
type PageResponse struct {
    List     interface{} `json:"list"`
    Total    int64       `json:"total"`
    Page     int         `json:"page"`
    PageSize int         `json:"pageSize"`
}

func SuccessPage(c *gin.Context, list interface{}, total int64, page, pageSize int) {
    result.SuccessHasData(c, PageResponse{
        List:     list,
        Total:    total,
        Page:     page,
        PageSize: pageSize,
    })
}
```

使用示例：

```go
r.GET("/users", func(c *gin.Context) {
    page := 1
    pageSize := 10
    users, total := getUsers(page, pageSize)

    result.SuccessHasData(c, PageResponse{
        List:     users,
        Total:    total,
        Page:     page,
        PageSize: pageSize,
    })
})
```

响应：

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {"id": 1, "name": "User1"},
      {"id": 2, "name": "User2"}
    ],
    "total": 100,
    "page": 1,
    "pageSize": 10
  },
  "timestamp": 1640995200000
}
```

## 完整示例

```go
package main

import (
    "github.com/bamboo-services/bamboo-base-go/web"
    "github.com/bamboo-services/bamboo-base-go/web/result"
    "github.com/gin-gonic/gin"
)

type User struct {
    ID   int64  `json:"id"`
    Name string `json:"name"`
}

func main() {
    r := web.Default()

    // 成功响应（无数据）
    r.POST("/ping", func(c *gin.Context) {
        result.Success(c, "pong")
    })

    // 成功响应（有数据）
    r.GET("/user", func(c *gin.Context) {
        user := User{ID: 1, Name: "Bamboo"}
        result.SuccessHasData(c, user)
    })

    // 错误响应
    r.GET("/error", func(c *gin.Context) {
        err := errors.New("something went wrong")
        result.Error(c, err)
    })

    r.Run(":8080")
}
```

## 下一步

<Cards>
  <Card title="错误处理" href="./error" />
  <Card title="中间件" href="./middleware" />
</Cards>
