---
title: gRPC 错误处理
description: xGrpcError 包提供 gRPC 场景下的结构化错误封装
icon: AlertCircle
---

# xGrpcError 包

`xGrpcError` 包提供 gRPC 场景下的结构化错误封装，与内置 `error.proto` 中的 `GrpcError` 消息对应。

```go
import xGrpcError "github.com/bamboo-services/bamboo-base-go/grpc/error"
```

## 核心类型

### ErrMessage 类型

```go
type ErrMessage string
```

用于携带面向调用方的可读错误描述，与 `xError.ErrMessage` 语义一致。

### Error 结构体

```go
type Error struct {
    // [!code highlight:5]
    Code         uint64     // 错误码（对应 ErrorCode.Code）
    Output       string     // 输出标识（对应 ErrorCode.Output）
    Message      string     // 错误信息（对应 ErrorCode.Message）
    ErrorMessage ErrMessage // 自定义错误描述
    Data         any        // 附加数据
}
```

字段与 `GrpcError` proto 消息一一对应：

| 字段 | proto 字段 | 说明 |
|------|-----------|------|
| `Code` | `code` | 5 位错误码，如 `40400` |
| `Output` | `output` | 大写标识，如 `NOT_FOUND` |
| `Message` | `message` | 中文描述，如 `未找到` |
| `ErrorMessage` | `error_message` | 调用方可读的详细描述 |
| `Data` | `data` | 附加数据，序列化为 `google.protobuf.Any` |

## 创建错误

### New

从预定义错误码创建 gRPC 错误。

```go
func New(errorCode *xError.ErrorCode, errorMessage ErrMessage, data ...any) *Error
```

**示例：**

```go
func (s *UserServer) GetUser(ctx context.Context, req *pb.GetUserRequest) (*pb.GetUserResponse, error) {
    user, err := s.repo.FindByID(ctx, req.Id)
    if err != nil {
        // [!code highlight:4]
        return nil, xGrpcError.New(
            xError.NotFound,
            "用户不存在",
        ).ToStatus().Err()
    }
    // ...
}
```

### Wrap

包装已有的 `error`，附加错误码信息。

```go
func Wrap(errorCode *xError.ErrorCode, errorMessage ErrMessage, err error) *Error
```

**示例：**

```go
if err := db.Find(&user).Error; err != nil {
    // [!code highlight:4]
    return nil, xGrpcError.Wrap(
        xError.InternalServerError,
        "数据库查询失败",
        err,
    ).ToStatus().Err()
}
```

### From

从 `*xError.Error` 转换为 gRPC 错误，便于复用 HTTP 层的错误定义。

```go
func From(xErr *xError.Error) *Error
```

**示例：**

```go
result, xErr := s.service.CreateOrder(ctx, req)
if xErr != nil {
    // [!code highlight]
    return nil, xGrpcError.From(xErr).ToStatus().Err()
}
```

## ToStatus

将 `*Error` 转换为 gRPC `status.Status`，携带结构化 `GrpcError` details。

```go
func (e *Error) ToStatus() *status.Status
```

转换后的 gRPC status code 由 `Code` 字段自动映射：

| 错误码范围 | gRPC Status Code |
|-----------|-----------------|
| 40000–40099 | `InvalidArgument` |
| 40100–40199 | `Unauthenticated` |
| 40300–40399 | `PermissionDenied` |
| 40400–40499 | `NotFound` |
| 50000–50099 | `Internal` |

## 下一步

<Cards>
  <Card title="gRPC 结果处理" href="/docs/bamboo-base-go/grpc/result" />
  <Card title="内置 Proto" href="/docs/bamboo-base-go/grpc/proto" />
  <Card title="内置拦截器" href="/docs/bamboo-base-go/grpc/interceptors" />
</Cards>
