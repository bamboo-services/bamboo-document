---
title: 密码处理
description: 基于 bcrypt 的密码加密与验证
icon: Lock
---

import { TypeTable } from '@/components/type-table';

# 密码处理

`xUtil` 提供基于 bcrypt 的密码加密和验证函数，额外使用 Base64 编码增强安全性。

## 加密流程

```
明文密码 → Base64 编码 → bcrypt 哈希 → 存储
```

## 密码加密

### EncryptPassword

加密密码并返回字节切片：

```go title="password.go"
// [!code highlight]
func EncryptPassword(pass string) ([]byte, error)
```

### MustEncryptPassword

加密密码，失败时 panic：

```go title="password.go"
// [!code highlight]
func MustEncryptPassword(pass string) []byte
```

### EncryptPasswordString

加密密码并返回字符串：

```go title="password.go"
// [!code highlight]
func EncryptPasswordString(pass string) (string, error)
```

### MustEncryptPasswordString

加密密码返回字符串，失败时 panic：

```go title="password.go"
// [!code highlight]
func MustEncryptPasswordString(pass string) string
```

**示例：**

```go
// [!code highlight:2]
// 推荐：返回字符串，便于存储
hash, err := xUtil.EncryptPasswordString("myPassword123")
if err != nil {
    log.Fatal(err)
}

// [!code highlight:2]
// 简便方式（失败时 panic）
hash := xUtil.MustEncryptPasswordString("myPassword123")
```

## 密码验证

### VerifyPassword

验证密码是否匹配：

```go title="password.go"
// [!code highlight]
func VerifyPassword(inputPass, hashPass string) error
```

**返回：** 匹配返回 `nil`，不匹配返回错误。

### IsPasswordValid

验证密码是否匹配（布尔值）：

```go title="password.go"
// [!code highlight]
func IsPasswordValid(inputPass, hashPass string) bool
```

**示例：**

```go
hash := xUtil.MustEncryptPasswordString("myPassword123")

// [!code highlight:2]
// 方式一：检查错误
err := xUtil.VerifyPassword("myPassword123", hash)
if err != nil {
    fmt.Println("密码错误")
}

// [!code highlight:2]
// 方式二：布尔值
if xUtil.IsPasswordValid("myPassword123", hash) {
    fmt.Println("密码正确")
}
```

## 使用示例

### 用户注册

```go title="service/user.go"
func (s *UserService) Register(ctx context.Context, req *dto.RegisterRequest) error {
    // [!code highlight:2]
    // 加密密码
    hash, err := xUtil.EncryptPasswordString(req.Password)
    if err != nil {
        return err
    }

    user := &entity.User{
        Username: req.Username,
        // [!code highlight]
        Password: hash,
    }

    return s.repo.Create(ctx, user)
}
```

### 用户登录

```go title="service/user.go"
func (s *UserService) Login(ctx context.Context, req *dto.LoginRequest) (*entity.User, error) {
    user, err := s.repo.FindByUsername(ctx, req.Username)
    if err != nil {
        return nil, err
    }

    // [!code highlight:3]
    // 验证密码
    if !xUtil.IsPasswordValid(req.Password, user.Password) {
        return nil, errors.New("密码错误")
    }

    return user, nil
}
```

### 修改密码

```go title="service/user.go"
func (s *UserService) ChangePassword(ctx context.Context, userID int64, oldPass, newPass string) error {
    user, err := s.repo.FindByID(ctx, userID)
    if err != nil {
        return err
    }

    // [!code highlight:3]
    // 验证旧密码
    if !xUtil.IsPasswordValid(oldPass, user.Password) {
        return errors.New("原密码错误")
    }

    // [!code highlight:2]
    // 加密新密码
    hash, err := xUtil.EncryptPasswordString(newPass)
    if err != nil {
        return err
    }

    return s.repo.UpdatePassword(ctx, userID, hash)
}
```

## 安全说明

- **bcrypt**：使用 bcrypt 算法，自动加盐，抗彩虹表攻击
- **Base64 预处理**：先进行 Base64 编码，增加一层保护
- **默认成本**：使用 `bcrypt.DefaultCost`（10），平衡安全性和性能
- **不可逆**：哈希后的密码无法还原为明文

## 下一步

<Cards>
  <Card title="安全密钥" href="./security" />
  <Card title="随机生成" href="./generate" />
</Cards>
