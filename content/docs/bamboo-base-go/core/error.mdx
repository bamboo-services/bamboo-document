---
title: 错误处理
description: IError 接口设计与 40+ 预定义错误码
icon: SearchAlert
---

# 错误处理

Bamboo Base 提供统一的错误处理机制，支持自定义错误和 40+ 预定义错误码。

## IError 接口

所有错误类型都实现 `IError` 接口：

```go
type IError interface {
    error
    Code() int
    Message() string
}
```

## Error 结构体

```go
type Error struct {
    // 错误代码
    ErrCode int

    // 错误消息
    ErrMessage string

    // 原始错误（可选）
    Cause error
}

func (e *Error) Error() string {
    return e.ErrMessage
}

func (e *Error) Code() int {
    return e.ErrCode
}

func (e *Error) Message() string {
    return e.ErrMessage
}
```

## 创建自定义错误

### 使用 New 函数

```go
func New(code int, message string) *Error
```

示例：

```go
err := error.New(400001, "用户名不能为空")
fmt.Println(err.Code())    // 400001
fmt.Println(err.Message()) // 用户名不能为空
```

### 使用 Wrap 包装原始错误

```go
func Wrap(code int, message string, cause error) *Error
```

示例：

```go
dbErr := db.Query("SELECT * FROM users")
if dbErr != nil {
    err := error.Wrap(500001, "数据库查询失败", dbErr)
    return err
}
```

## 错误码规范

错误码采用 6 位数字格式：`XXYYYY`

- `XX` - 模块/类别代码
- `YYYY` - 具体错误序号

### 模块代码

| 代码 | 模块 |
|------|------|
| 00 | 系统级错误 |
| 10 | 用户/认证错误 |
| 20 | 数据/数据库错误 |
| 30 | 业务逻辑错误 |
| 40 | 外部服务错误 |

## 预定义错误码

### 系统级错误 (00xxxx)

```go
var (
    // 系统内部错误
    ErrInternal = New(000001, "系统内部错误")

    // 服务不可用
    ErrServiceUnavailable = New(000002, "服务不可用")

    // 请求超时
    ErrTimeout = New(000003, "请求超时")

    // 系统繁忙
    ErrBusy = New(000004, "系统繁忙，请稍后再试")
)
```

### 参数错误 (10xxxx)

```go
var (
    // 参数错误
    ErrInvalidParams = New(100001, "请求参数错误")

    // 缺少必要参数
    ErrMissingParam = New(100002, "缺少必要参数")

    // 参数格式错误
    ErrParamFormat = New(100003, "参数格式错误")

    // 参数超出范围
    ErrParamOutOfRange = New(100004, "参数超出有效范围")
)
```

### 认证授权错误 (11xxxx)

```go
var (
    // 未授权
    ErrUnauthorized = New(110001, "未授权，请先登录")

    // Token 无效
    ErrInvalidToken = New(110002, "Token 无效或已过期")

    // 权限不足
    ErrForbidden = New(110003, "权限不足")

    // 登录失败
    ErrLoginFailed = New(110004, "用户名或密码错误")

    // 账号已禁用
    ErrAccountDisabled = New(110005, "账号已被禁用")

    // 账号已锁定
    ErrAccountLocked = New(110006, "账号已被锁定")
)
```

### 数据错误 (20xxxx)

```go
var (
    // 数据不存在
    ErrNotFound = New(200001, "数据不存在")

    // 数据已存在
    ErrAlreadyExists = New(200002, "数据已存在")

    // 数据冲突
    ErrConflict = New(200003, "数据冲突")

    // 数据库错误
    ErrDatabase = New(200004, "数据库操作失败")

    // 外键约束错误
    ErrForeignKey = New(200005, "违反外键约束")
)
```

### 业务错误 (30xxxx)

```go
var (
    // 操作失败
    ErrOperationFailed = New(300001, "操作失败")

    // 状态不允许
    ErrInvalidStatus = New(300002, "当前状态不允许此操作")

    // 资源不足
    ErrInsufficientResource = New(300003, "资源不足")

    // 超出限制
    ErrLimitExceeded = New(300004, "超出操作限制")
)
```

### 文件错误 (40xxxx)

```go
var (
    // 文件上传失败
    ErrUploadFailed = New(400001, "文件上传失败")

    // 文件过大
    ErrFileTooLarge = New(400002, "文件大小超出限制")

    // 文件类型不支持
    ErrFileTypeNotSupported = New(400003, "不支持的文件类型")

    // 文件不存在
    ErrFileNotFound = New(400004, "文件不存在")
)
```

## 错误码速查表

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 000001 | 系统内部错误 | 通用系统错误 |
| 000002 | 服务不可用 | 服务维护或故障 |
| 000003 | 请求超时 | 处理时间过长 |
| 100001 | 请求参数错误 | 参数验证失败 |
| 100002 | 缺少必要参数 | 必填参数缺失 |
| 110001 | 未授权 | 需要登录 |
| 110002 | Token 无效 | 认证令牌问题 |
| 110003 | 权限不足 | 无权访问 |
| 110004 | 用户名或密码错误 | 登录失败 |
| 200001 | 数据不存在 | 记录未找到 |
| 200002 | 数据已存在 | 重复数据 |
| 200004 | 数据库操作失败 | SQL 执行错误 |
| 300001 | 操作失败 | 业务操作失败 |
| 400001 | 文件上传失败 | 上传异常 |
| 400002 | 文件大小超出限制 | 文件过大 |

## 在 Handler 中使用

```go
package main

import (
    "github.com/bamboo-services/bamboo-base-go/error"
    "github.com/bamboo-services/bamboo-base-go/web/result"
    "github.com/gin-gonic/gin"
)

func getUser(c *gin.Context) {
    id := c.Param("id")

    user, err := db.FindUser(id)
    if err != nil {
        // 返回统一错误响应
        result.Error(c, error.ErrNotFound)
        return
    }

    result.SuccessHasData(c, user)
}

func createUser(c *gin.Context) {
    var req CreateUserRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        result.Error(c, error.ErrInvalidParams)
        return
    }

    // 检查用户名是否已存在
    if db.UserExists(req.Username) {
        result.Error(c, error.ErrAlreadyExists)
        return
    }

    // 创建用户...
    result.Success(c, "创建成功")
}
```

## 错误处理中间件

```go
func ErrorMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()

        if len(c.Errors) > 0 {
            err := c.Errors.Last().Err

            var appErr *error.Error
            if errors.As(err, &appErr) {
                // 应用错误，返回定义的错误码
                c.JSON(200, BaseResponse{
                    Code:    appErr.Code(),
                    Message: appErr.Message(),
                })
            } else {
                // 未知错误，返回系统错误
                c.JSON(200, BaseResponse{
                    Code:    000001,
                    Message: "系统内部错误",
                })
            }
        }
    }
}
```

## 下一步

<Cards>
  <Card title="统一响应" href="./response" />
  <Card title="中间件" href="./middleware" />
  <Card title="模型基类" href="./models" />
</Cards>
