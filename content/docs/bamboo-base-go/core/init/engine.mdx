---
title: 引擎初始化
description: engineInit 创建并配置 Gin 引擎，注册内置中间件和验证器，并注入初始化上下文
icon: Cog
---

# 引擎初始化

`engineInit` 方法创建并配置 Gin 引擎，注册内置中间件、自定义验证器，并将初始化上下文注入到每个 HTTP 请求。

## engineInit

```go title="register_gin.go"
// [!code highlight:2]
// 私有方法，在 Register 流程中自动调用
func (r *Reg) engineInit()
```

## 实现细节

```go title="register_gin.go"
func (r *Reg) engineInit() {
    log := xLog.WithName(xLog.NamedINIT)

    log.Debug(r.Init.Ctx, "初始化 GIN 引擎")
    // [!code highlight:3]
    if !xCtxUtil.IsDebugMode() {
        gin.SetMode(gin.ReleaseMode)
    }

    // [!code highlight:6]
    // 注册验证器和翻译器
    if v, ok := binding.Validator.Engine().(*validator.Validate); ok {
        xVaild.RegisterTranslator(v)
        xVaild.RegisterCustomValidators(v)
    }

    // [!code highlight:7]
    // 创建 Gin 引擎并注册中间件
    r.Serve = gin.New(func(engine *gin.Engine) {
        engine.Use(xHelper.RequestContext())
        engine.Use(xHelper.PanicRecovery())
        engine.Use(xHelper.HttpLogger())
        engine.Use(injectContext(r.Init.Ctx))  // 注入初始化上下文
    })
}
```

## 上下文注入

关键改进：将节点管理器的上下文注入到每个 HTTP 请求：

```go title="register_gin.go"
// [!code highlight:2]
// 注入初始化上下文到每个请求
func injectContext(ctx context.Context) func(c *gin.Context) {
    return func(c *gin.Context) {
        // [!code highlight:2]
        // 将初始化上下文合并到请求上下文
        c.Request = c.Request.WithContext(ctx)
        c.Next()
    }
}
```

**这意味着：**
- 所有通过节点注入的资源（数据库、Redis 等）都可以通过 `c.Request.Context()` 获取
- 业务代码使用标准 `context.Context`，实现框架解耦

## 内置中间件

| 中间件 | 说明 |
|--------|------|
| `xHelper.RequestContext()` | 请求上下文处理，生成请求 ID 等 |
| `xHelper.PanicRecovery()` | Panic 恢复，防止单个请求崩溃影响整个服务 |
| `xHelper.HttpLogger()` | HTTP 请求日志记录 |
| `injectContext(ctx)` | 注入初始化上下文到请求 |

## 运行模式

根据 `DEBUG` 环境变量自动切换 Gin 运行模式：

| 环境变量 | Gin 模式 | 说明 |
|---------|---------|------|
| `DEBUG=true` | Debug | 输出详细调试信息 |
| `DEBUG=false` 或未设置 | Release | 生产模式，关闭调试输出 |

## 验证器

### 翻译器

注册中文翻译器，将验证错误信息翻译为中文：

```go
type CreateUserReq struct {
    Name  string `json:"name" binding:"required"`
    Email string `json:"email" binding:"required,email"`
}

// 验证失败时返回中文错误信息
// "Name 为必填字段"
// "Email 必须是有效的邮箱地址"
```

### 自定义验证器

框架预置了常用的自定义验证器：

```go
type CreateUserReq struct {
    // [!code highlight]
    Phone string `json:"phone" binding:"required,phone"`  // 手机号验证
    // [!code highlight]
    IDCard string `json:"id_card" binding:"required,idcard"` // 身份证验证
}
```

## 使用引擎

初始化完成后，通过 `reg.Serve` 访问 Gin 引擎：

```go
reg := xReg.Register(context.Background(), nodeList)

// [!code highlight:4]
// 注册路由
reg.Serve.GET("/api/users", userHandler.List)
reg.Serve.POST("/api/users", userHandler.Create)
reg.Serve.PUT("/api/users/:id", userHandler.Update)

// [!code highlight:2]
// 路由分组
api := reg.Serve.Group("/api/v1")
{
    api.GET("/products", productHandler.List)
    api.POST("/orders", orderHandler.Create)
}

// [!code highlight:2]
// 启动服务
reg.Serve.Run(":8080")
```

## 在 Handler 中获取资源

```go
func MyHandler(c *gin.Context) {
    // [!code highlight:2]
    // 获取标准上下文（包含所有注入的资源）
    ctx := c.Request.Context()

    // [!code highlight:2]
    // 使用 xCtxUtil 获取资源
    db := xCtxUtil.MustGetDB(ctx)
    rdb := xCtxUtil.MustGetRDB(ctx)
    node := xCtxUtil.GetSnowflakeNode(ctx)
}
```

## 下一步

<Cards>
  <Card title="快速开始" href="/docs/bamboo-base-go/core/init" />
  <Card title="上下文管理" href="/docs/bamboo-base-go/core/context" />
</Cards>
