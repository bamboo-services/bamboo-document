---
title: å¿«é€Ÿå¼€å§‹
description: xReg åŒ…æä¾›èŠ‚ç‚¹åŒ–åˆå§‹åŒ–ç³»ç»Ÿï¼Œæ”¯æŒçµæ´»çš„ç»„ä»¶æ³¨å†Œ
icon: Rocket
---

import { TypeTable } from '@/components/type-table';

# xReg åŒ…

`xReg` åŒ…æ˜¯ Bamboo Base çš„æ ¸å¿ƒæ³¨å†Œæ¨¡å—ï¼Œé‡‡ç”¨**èŠ‚ç‚¹åŒ–æ¨¡å¼**å®ç°çµæ´»çš„ç»„ä»¶åˆå§‹åŒ–å’Œä¾èµ–æ³¨å…¥ã€‚

```go
import xReg "github.com/bamboo-services/bamboo-base-go/register"
import xRegNode "github.com/bamboo-services/bamboo-base-go/register/node"
```

## Reg ç»“æ„ä½“

åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒæ³¨å†Œç»“æ„ï¼ŒåŒ…å«æ‰€æœ‰åˆå§‹åŒ–åçš„ç»„ä»¶å®ä¾‹ï¼š

```go title="register.go"
type Reg struct {
    // [!code highlight:2]
    Serve *gin.Engine       // Gin å¼•æ“å®ä¾‹
    Init  *xRegNode.RegNode // åˆå§‹åŒ–èŠ‚ç‚¹ç®¡ç†å™¨
}
```

<TypeTable
  type={{
    Serve: {
      description: 'Gin å¼•æ“å®ä¾‹ï¼Œç”¨äºå¤„ç† HTTP è¯·æ±‚',
      type: '*gin.Engine',
      required: true,
    },
    Init: {
      description: 'èŠ‚ç‚¹ç®¡ç†å™¨ï¼ŒåŒ…å«åˆå§‹åŒ–ä¸Šä¸‹æ–‡å’ŒèŠ‚ç‚¹åˆ—è¡¨',
      type: '*xRegNode.RegNode',
      required: true,
    },
  }}
/>

## Register

æ³¨å†Œå¹¶åˆå§‹åŒ–åº”ç”¨çš„æ‰€æœ‰æ ¸å¿ƒç»„ä»¶ï¼Œæ”¯æŒè‡ªå®šä¹‰åˆå§‹åŒ–èŠ‚ç‚¹ã€‚

```go title="register.go"
// [!code highlight]
func Register(ctx context.Context, nodeList []xRegNode.RegNodeList) *Reg
```

**å‚æ•°è¯´æ˜ï¼š**

<TypeTable
  type={{
    ctx: {
      description: 'ä¸Šä¸‹æ–‡ï¼Œç”¨äºæ§åˆ¶å–æ¶ˆå’Œè¶…æ—¶',
      type: 'context.Context',
      required: true,
    },
    nodeList: {
      description: 'è‡ªå®šä¹‰åˆå§‹åŒ–èŠ‚ç‚¹åˆ—è¡¨',
      type: '[]xRegNode.RegNodeList',
      required: true,
    },
  }}
/>

**åˆå§‹åŒ–é¡ºåºï¼š**

```
Register(ctx, nodeList)
    â”œâ”€â”€ configInit()           // 1. åŠ è½½é…ç½®ï¼ˆç§æœ‰ï¼‰
    â”œâ”€â”€ loggerInit()           // 2. åˆå§‹åŒ–æ—¥å¿—ï¼ˆç§æœ‰ï¼‰
    â”œâ”€â”€ SnowflakeInit          // 3. å†…ç½®é›ªèŠ±ç®—æ³•èŠ‚ç‚¹
    â”œâ”€â”€ [è‡ªå®šä¹‰èŠ‚ç‚¹...]         // 4. ç”¨æˆ·è‡ªå®šä¹‰èŠ‚ç‚¹
    â””â”€â”€ engineInit()           // 5. å¯åŠ¨ Gin å¼•æ“ï¼ˆç§æœ‰ï¼‰
```

**ç¤ºä¾‹ï¼š**

```go title="main.go"
package main

import (
    "context"

    xConsts "github.com/bamboo-services/bamboo-base-go/context"
    xReg "github.com/bamboo-services/bamboo-base-go/register"
    xRegNode "github.com/bamboo-services/bamboo-base-go/register/node"
)

func main() {
    // [!code highlight:8]
    // åˆå§‹åŒ–ï¼Œä¼ å…¥è‡ªå®šä¹‰èŠ‚ç‚¹
    reg := xReg.Register(context.Background(), []xRegNode.RegNodeList{
        {
            Key:  xConsts.DatabaseKey,
            Node: initDatabase,  // è‡ªå®šä¹‰æ•°æ®åº“åˆå§‹åŒ–
        },
    })

    // æ³¨å†Œè·¯ç”±
    reg.Serve.GET("/ping", func(c *gin.Context) {
        c.String(200, "pong")
    })

    // å¯åŠ¨æœåŠ¡
    reg.Serve.Run(":8080")
}

// [!code highlight:2]
// è‡ªå®šä¹‰åˆå§‹åŒ–èŠ‚ç‚¹
func initDatabase(ctx context.Context) (any, error) {
    // ä»ä¸Šä¸‹æ–‡è·å–é…ç½®ï¼ˆå‰é¢èŠ‚ç‚¹çš„ç»“æœï¼‰
    // åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    db, err := gorm.Open(...)
    return db, err
}
```

## èŠ‚ç‚¹åŒ–ç³»ç»Ÿ

### RegNode ç»“æ„

```go title="register/node/node.go"
// [!code highlight:2]
// Node å®šä¹‰åˆå§‹åŒ–å‡½æ•°ç­¾å
type Node func(ctx context.Context) (any, error)

// [!code highlight:2]
// RegNodeList å­˜å‚¨èŠ‚ç‚¹ä¿¡æ¯
type RegNodeList struct {
    Key  xConsts.ContextKey  // ä¸Šä¸‹æ–‡é”®
    Node Node                // åˆå§‹åŒ–å‡½æ•°
}

// [!code highlight:2]
// RegNode èŠ‚ç‚¹ç®¡ç†å™¨
type RegNode struct {
    list []RegNodeList
    Ctx  context.Context
}
```

### æ ¸å¿ƒæ–¹æ³•

```go title="register/node/node.go"
// [!code highlight:2]
// Use æ³¨å†Œåˆå§‹åŒ–èŠ‚ç‚¹
func (rn *RegNode) Use(ctxKey xConsts.ContextKey, registerFunc Node)

// [!code highlight:2]
// Exec æŒ‰é¡ºåºæ‰§è¡Œæ‰€æœ‰èŠ‚ç‚¹
func (rn *RegNode) Exec()
```

### æ‰§è¡Œæµç¨‹

```go title="register/node/node.go"
func (rn *RegNode) Exec() {
    for i, node := range rn.list {
        // [!code highlight:2]
        // æ‰§è¡ŒèŠ‚ç‚¹åˆå§‹åŒ–
        val, err := node.Node(rn.Ctx)
        if err != nil {
            panic(fmt.Sprintf("æ‰§è¡Œæ³¨å†ŒèŠ‚ç‚¹å¤±è´¥: index=%d Key=%v err=%v", i, node.Key, err))
        }
        // [!code highlight:2]
        // å°†ç»“æœå­˜å…¥ä¸Šä¸‹æ–‡ï¼Œä¾›åç»­èŠ‚ç‚¹ä½¿ç”¨
        rn.Ctx = context.WithValue(rn.Ctx, node.Key, val)
    }
    rn.list = nil // é‡Šæ”¾å†…å­˜
}
```

**ç‰¹ç‚¹ï¼š**
- ğŸ”„ **ä¾èµ–æ³¨å…¥**ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯è®¿é—®å‰é¢èŠ‚ç‚¹çš„åˆå§‹åŒ–ç»“æœ
- ğŸ“Š **é¡ºåºæ‰§è¡Œ**ï¼šæŒ‰æ³¨å†Œé¡ºåºä¾æ¬¡åˆå§‹åŒ–
- ğŸ›¡ï¸ **é”™è¯¯å¤„ç†**ï¼šä»»ä½•èŠ‚ç‚¹å¤±è´¥éƒ½ä¼š panic å¹¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯

## å†…ç½®åˆå§‹åŒ–

### é…ç½®åˆå§‹åŒ–ï¼ˆç§æœ‰ï¼‰

ä» `.env` æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡é…ç½®ã€‚

è¯¦è§ï¼š[é…ç½®åˆå§‹åŒ–](./config)

### æ—¥å¿—åˆå§‹åŒ–ï¼ˆç§æœ‰ï¼‰

åˆå§‹åŒ–æ—¥å¿—è®°å½•å™¨ï¼Œæ”¯æŒæ§åˆ¶å°å½©è‰²è¾“å‡ºå’Œæ–‡ä»¶ JSON è®°å½•ã€‚

è¯¦è§ï¼š[æ—¥å¿—åˆå§‹åŒ–](./logger)

### é›ªèŠ±ç®—æ³•èŠ‚ç‚¹ï¼ˆå†…ç½®ï¼‰

ä½œä¸ºå†…ç½®èŠ‚ç‚¹è‡ªåŠ¨æ³¨å†Œï¼Œåˆå§‹åŒ–é›ªèŠ±ç®—æ³•èŠ‚ç‚¹ã€‚

```go title="register.go"
// [!code highlight]
reg.Init.Use(xConsts.SnowflakeNodeKey, xInit.SnowflakeInit)
```

è¯¦è§ï¼š[é›ªèŠ±ç®—æ³•åˆå§‹åŒ–](./snowflake)

### å¼•æ“åˆå§‹åŒ–ï¼ˆç§æœ‰ï¼‰

åˆå§‹åŒ– Gin å¼•æ“ï¼Œæ³¨å†Œå†…ç½®ä¸­é—´ä»¶å’ŒéªŒè¯å™¨ï¼Œå¹¶æ³¨å…¥åˆå§‹åŒ–ä¸Šä¸‹æ–‡ã€‚

è¯¦è§ï¼š[å¼•æ“åˆå§‹åŒ–](./engine)

## ä¸Šä¸‹æ–‡æ³¨å…¥

å¼•æ“åˆå§‹åŒ–æ—¶ä¼šè‡ªåŠ¨å°†èŠ‚ç‚¹ç®¡ç†å™¨çš„ä¸Šä¸‹æ–‡æ³¨å…¥åˆ°æ¯ä¸ª HTTP è¯·æ±‚ï¼š

```go title="register_gin.go"
// [!code highlight:2]
// æ³¨å…¥åˆå§‹åŒ–ä¸Šä¸‹æ–‡åˆ°æ¯ä¸ªè¯·æ±‚
func injectContext(ctx context.Context) func(c *gin.Context) {
    return func(c *gin.Context) {
        c.Request = c.Request.WithContext(ctx)
        c.Next()
    }
}
```

è¿™æ„å‘³ç€åœ¨ä¸šåŠ¡ä»£ç ä¸­å¯ä»¥é€šè¿‡ `c.Request.Context()` è·å–åˆå§‹åŒ–æ—¶æ³¨å…¥çš„æ‰€æœ‰èµ„æºã€‚

## è°ƒè¯•æ¨¡å¼

é€šè¿‡ç¯å¢ƒå˜é‡ `DEBUG` æ§åˆ¶è°ƒè¯•æ¨¡å¼ï¼š

| ç¯å¢ƒå˜é‡ | å€¼ | æ•ˆæœ |
|---------|-----|------|
| `DEBUG` | `true` | å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼Œæ—¥å¿—çº§åˆ«ä¸º Debug |
| `DEBUG` | `false` æˆ–æœªè®¾ç½® | ç”Ÿäº§æ¨¡å¼ï¼Œæ—¥å¿—çº§åˆ«ä¸º Info |

## å®Œæ•´ç¤ºä¾‹

```go title="main.go"
package main

import (
    "context"

    xConsts "github.com/bamboo-services/bamboo-base-go/context"
    xReg "github.com/bamboo-services/bamboo-base-go/register"
    xRegNode "github.com/bamboo-services/bamboo-base-go/register/node"
    xResult "github.com/bamboo-services/bamboo-base-go/result"
    "github.com/gin-gonic/gin"
)

func main() {
    // [!code highlight:9]
    // åˆå§‹åŒ–ï¼Œæ³¨å†Œè‡ªå®šä¹‰èŠ‚ç‚¹
    reg := xReg.Register(context.Background(), []xRegNode.RegNodeList{
        {Key: xConsts.DatabaseKey, Node: initDatabase},
        {Key: xConsts.RedisClientKey, Node: initRedis},
    })

    // æ³¨å†Œè·¯ç”±
    // [!code highlight:4]
    reg.Serve.GET("/api/status", func(c *gin.Context) {
        xResult.SuccessHasData(c, "æœåŠ¡æ­£å¸¸", gin.H{
            "status": "running",
        })
    })

    // å¯åŠ¨æœåŠ¡
    // [!code highlight]
    reg.Serve.Run(":8080")
}

// [!code highlight:2]
// æ•°æ®åº“åˆå§‹åŒ–èŠ‚ç‚¹
func initDatabase(ctx context.Context) (any, error) {
    // åˆå§‹åŒ–æ•°æ®åº“...
    return db, nil
}

// [!code highlight:2]
// Redis åˆå§‹åŒ–èŠ‚ç‚¹
func initRedis(ctx context.Context) (any, error) {
    // åˆå§‹åŒ– Redis...
    return rdb, nil
}
```

## ä¸‹ä¸€æ­¥

<Cards>
  <Card title="é…ç½®åˆå§‹åŒ–" href="./config" />
  <Card title="æ—¥å¿—åˆå§‹åŒ–" href="./logger" />
  <Card title="é›ªèŠ±ç®—æ³•åˆå§‹åŒ–" href="./snowflake" />
  <Card title="å¼•æ“åˆå§‹åŒ–" href="./engine" />
</Cards>
