---
title: 上下文键
description: xConsts 包定义的上下文键常量
icon: Key
---

import { TypeTable } from '@/components/type-table';

# 上下文键

`xConsts` 包定义了用于在上下文中存储和获取数据的键常量。

```go
import xConsts "github.com/bamboo-services/bamboo-base-go/context"
```

## ContextKey 类型

```go title="context.go"
// [!code highlight]
type ContextKey string

func (s ContextKey) String() string {
    return string(s)
}
```

## 预定义键

```go title="context.go"
const (
    // [!code highlight:9]
    Nil              ContextKey = ""                        // 空值
    Exec             ContextKey = "special_execution"       // 特殊执行
    RequestKey       ContextKey = "context_request_key"     // 请求唯一标识
    ErrorCodeKey     ContextKey = "context_error_code"      // 错误码
    ErrorMessageKey  ContextKey = "context_error_message"   // 错误描述
    UserStartTimeKey ContextKey = "context_user_start_time" // 请求开始时间
    DatabaseKey      ContextKey = "context_database"        // 数据库客户端
    RedisClientKey   ContextKey = "context_redis_client"    // Redis 客户端
    SnowflakeNodeKey ContextKey = "context_snowflake_node"  // 雪花算法节点
)
```

## 键说明

<TypeTable
  type={{
    Nil: {
      description: '空值键，用于表示无效或未设置的键',
      type: '""',
      required: false,
    },
    Exec: {
      description: '特殊执行标记，用于标识特殊执行流程',
      type: 'string',
      required: false,
    },
    RequestKey: {
      description: '请求唯一标识，UUID 格式，用于链路追踪和日志关联',
      type: 'string',
      required: true,
    },
    ErrorCodeKey: {
      description: '错误码，用于错误处理中间件',
      type: '*xError.ErrorCode',
      required: true,
    },
    ErrorMessageKey: {
      description: '错误描述信息，用于错误处理中间件',
      type: 'string',
      required: true,
    },
    UserStartTimeKey: {
      description: '请求开始时间，用于计算请求耗时',
      type: 'time.Time',
      required: true,
    },
    DatabaseKey: {
      description: 'GORM 数据库连接实例',
      type: '*gorm.DB',
      required: true,
    },
    RedisClientKey: {
      description: 'Redis 客户端实例',
      type: '*redis.Client',
      required: true,
    },
    SnowflakeNodeKey: {
      description: '雪花算法节点，用于生成分布式唯一 ID',
      type: '*xSnowflake.Node',
      required: true,
    },
  }}
/>

## 使用方式

### 节点化注入（推荐）

在 `Register` 时通过节点注入资源：

```go
import (
    "context"
    xConsts "github.com/bamboo-services/bamboo-base-go/context"
    xReg "github.com/bamboo-services/bamboo-base-go/register"
    xRegNode "github.com/bamboo-services/bamboo-base-go/register/node"
)

// [!code highlight:8]
// 注册时注入数据库和 Redis
reg := xReg.Register(context.Background(), []xRegNode.RegNodeList{
    {Key: xConsts.DatabaseKey, Node: initDatabase},
    {Key: xConsts.RedisClientKey, Node: initRedis},
})

// [!code highlight:2]
// 初始化节点函数
func initDatabase(ctx context.Context) (any, error) {
    db, err := gorm.Open(...)
    return db, err
}
```

### 从上下文获取值

使用 `xCtxUtil` 工具函数获取注入的资源：

```go
import xCtxUtil "github.com/bamboo-services/bamboo-base-go/utility/ctxutil"

func MyHandler(c *gin.Context) {
    // [!code highlight:2]
    // 获取标准上下文
    ctx := c.Request.Context()

    // [!code highlight:2]
    // 获取数据库连接
    db := xCtxUtil.MustGetDB(ctx)

    // [!code highlight:2]
    // 获取 Redis 客户端
    rdb := xCtxUtil.MustGetRDB(ctx)

    // [!code highlight:2]
    // 获取雪花算法节点
    node := xCtxUtil.GetSnowflakeNode(ctx)
}
```

### 直接从上下文获取

也可以直接使用 `context.Value` 获取：

```go
import xConsts "github.com/bamboo-services/bamboo-base-go/context"

func MyHandler(c *gin.Context) {
    ctx := c.Request.Context()

    // [!code highlight:3]
    // 直接获取并类型断言
    if value := ctx.Value(xConsts.DatabaseKey); value != nil {
        db := value.(*gorm.DB)
    }
}
```

## 注入时机

| 键 | 注入位置 | 说明 |
|-----|---------|------|
| `RequestKey` | `xHelper.RequestContext()` | 框架自动注入 |
| `UserStartTimeKey` | `xHelper.RequestContext()` | 框架自动注入 |
| `SnowflakeNodeKey` | `xReg.Register()` 内置节点 | 框架自动注入 |
| `DatabaseKey` | 自定义初始化节点 | 需手动注入 |
| `RedisClientKey` | 自定义初始化节点 | 需手动注入 |
| `ErrorCodeKey` | 错误处理中间件 | 错误时自动设置 |
| `ErrorMessageKey` | 错误处理中间件 | 错误时自动设置 |

## 上下文流转

```
Register(ctx, nodeList)
    │
    ├── 内置节点注入 SnowflakeNodeKey
    │
    ├── 自定义节点注入 DatabaseKey, RedisClientKey, ...
    │
    └── engineInit()
            │
            └── injectContext(ctx) 中间件
                    │
                    └── 每个 HTTP 请求
                            │
                            └── c.Request.Context() 包含所有注入的资源
```

## 下一步

<Cards>
  <Card title="工具函数" href="/docs/bamboo-base-go/core/context/util" />
  <Card title="概述" href="/docs/bamboo-base-go/core/context" />
</Cards>
