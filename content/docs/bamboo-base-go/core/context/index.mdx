---
title: 概述
description: 上下文管理机制，基于标准 context.Context 实现框架解耦
icon: Layers
---

# 上下文管理

Bamboo Base 提供了完整的上下文管理机制，基于标准 `context.Context` 实现**框架解耦**。

## 相关包

| 包 | 别名 | 说明 |
|-----|------|------|
| `.../context` | `xCtx` | 上下文键常量定义 |
| `.../utility/ctxutil` | `xCtxUtil` | 上下文工具函数 |
| `.../helper` | `xHelper` | 上下文中间件 |
| `.../register/node` | `xRegNode` | 节点化注册系统 |

## 工作原理

<Mermaid
  chart="
sequenceDiagram
    participant Register
    participant Node
    participant Engine
    participant Middleware
    participant Handler

    Register->>Node: 注册初始化节点
    Node->>Node: 执行节点，结果存入 ctx
    Node->>Engine: 传递包含资源的 ctx
    Engine->>Middleware: injectContext(ctx)
    Middleware->>Handler: c.Request.Context()
    Handler->>Handler: xCtxUtil.MustGetDB(ctx)"
/>

## 上下文数据流

```go title="初始化流程"
// [!code highlight:2]
// 1. Register 创建节点管理器
xReg.Register(ctx, nodeList)
    │
    ├── configInit()           // 私有：加载配置
    ├── loggerInit()           // 私有：初始化日志
    │
    // [!code highlight:2]
    // 2. 内置节点注入雪花算法
    ├── SnowflakeNodeKey → *xSnowflake.Node
    │
    // [!code highlight:2]
    // 3. 自定义节点注入业务资源
    ├── DatabaseKey      → *gorm.DB
    ├── RedisClientKey   → *redis.Client
    │
    // [!code highlight:2]
    // 4. 引擎初始化，注入上下文到请求
    └── engineInit()
            └── injectContext(ctx)
```

```go title="请求流程"
// [!code highlight:2]
// 5. RequestContext 中间件注入请求级数据
xHelper.RequestContext()
    ├── RequestKey       → UUID 请求标识
    └── UserStartTimeKey → 请求开始时间
```

## 快速使用

```go
import (
    xCtxUtil "github.com/bamboo-services/bamboo-base-go/common/utility/context"
)

func MyHandler(c *gin.Context) {
    // [!code highlight:2]
    // 获取标准上下文
    ctx := c.Request.Context()

    // [!code highlight:2]
    // 获取数据库连接（Panic 版本）
    db := xCtxUtil.MustGetDB(ctx)

    // [!code highlight:2]
    // 获取数据库连接（错误返回版本）
    db, err := xCtxUtil.GetDB(ctx)

    // [!code highlight:2]
    // 获取 Redis 客户端
    rdb := xCtxUtil.MustGetRDB(ctx)

    // [!code highlight:2]
    // 生成雪花 ID
    id := xCtxUtil.MustGenerateSnowflakeID(ctx)

    // [!code highlight:2]
    // 获取请求 ID
    requestID := xCtxUtil.GetRequestKey(ctx)
}
```

## 上下文节点

`ContextNode` 用于在初始化阶段保存上下文中的资源条目，配合 `ContextNodeList` 形成有序的键值链式列表。

```go
import xCtx "github.com/bamboo-services/bamboo-base-go/defined/context"
```

### ContextNode 结构

```go
type ContextNode struct {
    Key   xCtx.ContextKey
    Value any
}
```

- `Key`：上下文键，用于标识资源类型
- `Value`：资源实例，支持任意类型

### ContextNodeList 结构

```go
type ContextNodeList []ContextNode

func NewCtxNodeList() ContextNodeList
func (c ContextNodeList) GetList() []ContextNode
func (c ContextNodeList) Get(key ContextKey) any
func (c *ContextNodeList) Append(key ContextKey, value any)
```

**常用能力：**
- `Get`：按键读取已注入资源
- `Append`：追加新的资源节点
- `GetList`：按顺序获取完整节点列表

### 使用示例

```go title="register.go"
nodeList := xCtx.NewCtxNodeList()
nodeList.Append(xCtx.DatabaseKey, initDatabase())
nodeList.Append(xCtx.RedisClientKey, initRedis())

reg := xReg.Register(ctx, []xRegNode.RegNodeList{
    {Key: xCtx.RegNodeKey, Node: func(ctx context.Context) (any, error) {
        return nodeList, nil
    }},
})
```


## 注入上下文

### 方式一：节点化注入（推荐）

在 `Register` 时通过自定义节点注入：

```go title="main.go"
import (
    "context"
    xCtx "github.com/bamboo-services/bamboo-base-go/defined/context"
    xReg "github.com/bamboo-services/bamboo-base-go/major/register"
    xRegNode "github.com/bamboo-services/bamboo-base-go/major/register/node"
)

func main() {
    // [!code highlight:6]
    reg := xReg.Register(context.Background(), []xRegNode.RegNodeList{
        {Key: xCtx.DatabaseKey, Node: initDatabase},
        {Key: xCtx.RedisClientKey, Node: initRedis},
    })

    reg.Serve.Run(":8080")
}

// [!code highlight:2]
// 数据库初始化节点
func initDatabase(ctx context.Context) (any, error) {
    db, err := gorm.Open(...)
    return db, err
}

// [!code highlight:2]
// Redis 初始化节点
func initRedis(ctx context.Context) (any, error) {
    rdb := redis.NewClient(...)
    return rdb, nil
}
```

### 方式二：中间件注入

在业务中间件中注入（适用于请求级资源）：

```go title="middleware.go"
func InjectUserMiddleware() gin.HandlerFunc {
    return func(c *gin.Context) {
        // 获取用户信息...
        user := getUserFromToken(c)

        // [!code highlight:2]
        // 注入到 Gin 上下文
        c.Set("user", user)

        c.Next()
    }
}
```

## 框架解耦

新版本的核心改进是**框架解耦**：

| 方面 | 旧设计 | 新设计 |
|------|-------|-------|
| 工具函数参数 | `*gin.Context` | `context.Context` |
| 资源注入 | Gin 中间件 | 节点化系统 |
| 上下文传递 | `c.Set()` / `c.Get()` | `context.WithValue()` |
| 业务代码 | 依赖 Gin | 可独立测试 |

**优势：**
- ✅ 业务逻辑不再依赖 Gin 框架
- ✅ 更容易编写单元测试
- ✅ 支持在非 HTTP 场景使用（如定时任务、消息队列）

## 下一步

<Cards>
  <Card title="上下文键" href="/docs/bamboo-base-go/core/context/keys" />
  <Card title="工具函数" href="/docs/bamboo-base-go/core/context/util" />
</Cards>
