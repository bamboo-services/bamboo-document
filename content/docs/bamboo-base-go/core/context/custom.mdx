---
title: 自定义注入
description: 扩展上下文，注入业务自定义数据
icon: Plus
---

# 自定义注入

除了框架预定义的上下文键，你可以扩展自定义的业务上下文键。

## 定义自定义键

在业务项目中创建自定义上下文键常量：

```go title="internal/constant/context/business.go"
package bContext

import xCtx "github.com/bamboo-services/bamboo-base-go/context"

const (
    // [!code highlight:4]
    // 使用 xCtx.ContextKey 类型定义自定义键
    TencentCloudForSmsKey xCtx.ContextKey = "business_tencent_cloud_sms" // 腾讯云短信
    UserEntityKey         xCtx.ContextKey = "business_user_entity"       // 用户实体
    MerchantEntityKey     xCtx.ContextKey = "business_merchant_entity"   // 商户实体
)
```

**命名规范：**

| 前缀 | 说明 | 示例 |
|------|------|------|
| `context_` | 框架预定义键 | `context_database` |
| `business_` | 业务自定义键 | `business_user_entity` |

## 注入自定义数据

### 启动时注入

在 `startup` 包中注入全局资源：

```go title="internal/app/startup/startup_context.go"
package startup

import (
    xCtx "github.com/bamboo-services/bamboo-base-go/context"
    xLog "github.com/bamboo-services/bamboo-base-go/log"
    "github.com/gin-gonic/gin"
    bContext "your-project/internal/constant/context"
)

type handler struct {
    Data *Reg
}

// [!code highlight]
// businessContextInit 初始化业务上下文
func (r *Reg) businessContextInit() {
    xLog.WithName(xLog.NamedINIT).Info(r.Context, "上下文系统注入")

    handler := &handler{
        Data: r,
    }

    // [!code highlight]
    r.Serve.Use(handler.systemContextHandlerFunc)
}

func (h *handler) systemContextHandlerFunc(c *gin.Context) {
    // [!code highlight:3]
    // 注入框架预定义资源
    c.Set(xCtx.DatabaseKey.String(), h.Data.DB)
    c.Set(xCtx.RedisClientKey.String(), h.Data.RDB)

    // [!code highlight:2]
    // 注入业务自定义资源
    c.Set(bContext.TencentCloudForSmsKey.String(), h.Data.Tencent.SmsClient)

    c.Next()
}
```

### 中间件中注入

在认证中间件中注入用户实体：

```go title="internal/app/middleware/auth_required.go"
package middleware

import (
    xError "github.com/bamboo-services/bamboo-base-go/error"
    xResult "github.com/bamboo-services/bamboo-base-go/result"
    xCtxUtil "github.com/bamboo-services/bamboo-base-go/utility/ctxutil"
    "github.com/gin-gonic/gin"
    bContext "your-project/internal/constant/context"
    "your-project/internal/logic"
)

func AuthRequired(ctx *gin.Context) {
    // ... 验证 token 逻辑 ...

    // 获取用户信息
    db := xCtxUtil.GetDB(ctx)
    rdb := xCtxUtil.GetRDB(ctx)
    user, xErr := logic.NewUser(db, rdb).GetUser(ctx, userID)
    if xErr != nil {
        xResult.AbortError(ctx, xErr.ErrorCode, xErr.ErrorMessage, nil)
        return
    }

    // [!code highlight:2]
    // 注入用户实体到上下文
    ctx.Set(bContext.UserEntityKey.String(), user)

    ctx.Next()
}
```

## 获取自定义数据

### 创建工具函数

为自定义键创建便捷的获取函数：

```go title="pkg/ctx/user.go"
package bCtxUtil

import (
    "github.com/gin-gonic/gin"
    bContext "your-project/internal/constant/context"
    "your-project/internal/entity"
)

// [!code highlight]
// GetUserEntity 从上下文获取当前登录用户
func GetUserEntity(ctx *gin.Context) *entity.User {
    value, exists := ctx.Get(bContext.UserEntityKey.String())
    if !exists {
        return nil
    }
    // [!code highlight]
    return value.(*entity.User)
}

// [!code highlight]
// MustGetUserEntity 从上下文获取当前登录用户（不存在则 panic）
func MustGetUserEntity(ctx *gin.Context) *entity.User {
    user := GetUserEntity(ctx)
    if user == nil {
        panic("用户实体不存在于上下文中")
    }
    return user
}
```

### 在 Handler 中使用

```go title="internal/handler/user.go"
package handler

import (
    xResult "github.com/bamboo-services/bamboo-base-go/result"
    "github.com/gin-gonic/gin"
    bCtxUtil "your-project/pkg/ctx"
)

func (h *UserHandler) GetProfile(ctx *gin.Context) {
    // [!code highlight:2]
    // 获取当前登录用户
    user := bCtxUtil.GetUserEntity(ctx)

    xResult.SuccessHasData(ctx, "获取成功", user)
}

func (h *UserHandler) UpdateProfile(ctx *gin.Context) {
    // [!code highlight:2]
    // 获取当前登录用户 ID
    currentUser := bCtxUtil.MustGetUserEntity(ctx)

    // 更新逻辑...
    h.service.UpdateUser(ctx, currentUser.ID, req)

    xResult.Success(ctx, "更新成功")
}
```

## 完整示例

### 项目结构

```
your-project/
├── internal/
│   ├── app/
│   │   ├── middleware/
│   │   │   └── auth_required.go    # 认证中间件
│   │   └── startup/
│   │       └── startup_context.go  # 上下文注入
│   ├── constant/
│   │   └── context/
│   │       └── business.go         # 自定义键定义
│   └── handler/
│       └── user.go
└── pkg/
    └── ctx/
        └── user.go                 # 自定义获取函数
```

### 自定义键定义

```go title="internal/constant/context/business.go"
package bContext

import xCtx "github.com/bamboo-services/bamboo-base-go/context"

const (
    // [!code highlight:5]
    // 用户相关
    UserEntityKey     xCtx.ContextKey = "business_user_entity"
    UserTokenKey      xCtx.ContextKey = "business_user_token"
    UserPermissionKey xCtx.ContextKey = "business_user_permission"

    // [!code highlight:3]
    // 第三方服务
    TencentSmsKey     xCtx.ContextKey = "business_tencent_sms"
    AliyunOssKey      xCtx.ContextKey = "business_aliyun_oss"
)
```

### 启动注入

```go title="internal/app/startup/startup_context.go"
package startup

import (
    xCtx "github.com/bamboo-services/bamboo-base-go/context"
    "github.com/gin-gonic/gin"
    bContext "your-project/internal/constant/context"
)

func (r *Reg) businessContextInit() {
    r.Serve.Use(func(c *gin.Context) {
        // [!code highlight:3]
        // 框架资源
        c.Set(xCtx.DatabaseKey.String(), r.DB)
        c.Set(xCtx.RedisClientKey.String(), r.RDB)

        // [!code highlight:3]
        // 业务资源
        c.Set(bContext.TencentSmsKey.String(), r.Tencent.SmsClient)
        c.Set(bContext.AliyunOssKey.String(), r.Aliyun.OssClient)

        c.Next()
    })
}
```

### 工具函数

```go title="pkg/ctx/business.go"
package bCtxUtil

import (
    "github.com/gin-gonic/gin"
    sms "github.com/tencentcloud/tencentcloud-sdk-go/tencentcloud/sms/v20210111"
    bContext "your-project/internal/constant/context"
    "your-project/internal/entity"
)

// [!code highlight]
func GetUserEntity(ctx *gin.Context) *entity.User {
    if v, ok := ctx.Get(bContext.UserEntityKey.String()); ok {
        return v.(*entity.User)
    }
    return nil
}

// [!code highlight]
func GetTencentSmsClient(ctx *gin.Context) *sms.Client {
    if v, ok := ctx.Get(bContext.TencentSmsKey.String()); ok {
        return v.(*sms.Client)
    }
    panic("腾讯云短信客户端未注入")
}
```

## 下一步

<Cards>
  <Card title="上下文键" href="./keys" />
  <Card title="工具函数" href="./util" />
</Cards>
