---
title: 工具函数
description: xCtxUtil 包提供便捷的上下文操作函数，已解耦 Gin 框架
icon: Wrench
---

import { TypeTable } from '@/components/type-table';

# 工具函数

`xCtxUtil` 包提供便捷的上下文操作函数，使用标准 `context.Context` 实现**框架解耦**。

```go
import xCtxUtil "github.com/bamboo-services/bamboo-base-go/utility/ctxutil"
```

## 设计理念

新版 `xCtxUtil` 采用**双版本 API** 设计：

| 版本 | 前缀 | 行为 | 适用场景 |
|------|------|------|----------|
| Panic 版本 | `Must*` | 失败时 panic | 确定资源已注入的场景 |
| 错误返回版本 | `Get*` | 返回 `*xError.Error` | 需要优雅处理错误的场景 |

## 通用函数

### IsDebugMode

判断当前是否处于调试模式。

```go title="common.go"
// [!code highlight]
func IsDebugMode() bool
```

**实现：**

```go title="common.go"
func IsDebugMode() bool {
    // [!code highlight]
    return xEnv.GetEnvBool(xEnv.Debug, false)
}
```

**示例：**

```go
if xCtxUtil.IsDebugMode() {
    // [!code highlight]
    // 调试模式下的特殊处理
    log.Debug(ctx, "调试信息")
}
```

### CalcOverheadTime

计算当前请求的耗时（微秒级）。

```go title="common.go"
// [!code highlight]
func CalcOverheadTime(ctx context.Context) int64
```

**说明：**
- 仅在调试模式下计算耗时
- 非调试模式始终返回 0
- 单位为微秒（microseconds）

**示例：**

```go
// [!code highlight]
overhead := xCtxUtil.CalcOverheadTime(c.Request.Context())
// overhead = 1234 (微秒)
```

### GetRequestKey

获取请求唯一标识。

```go title="common.go"
// [!code highlight]
func GetRequestKey(ctx context.Context) string
```

**示例：**

```go
// [!code highlight]
requestID := xCtxUtil.GetRequestKey(c.Request.Context())
// requestID = "550e8400-e29b-41d4-a716-446655440000"
```

### GetErrorMessage

获取上下文中的错误消息。

```go title="common.go"
// [!code highlight]
func GetErrorMessage(ctx context.Context) string
```

## 通用组件获取

当需要读取自定义注入的组件时，可使用泛型的 `MustGet` / `Get`：

```go
import xConsts "github.com/bamboo-services/bamboo-base-go/context"
```

### MustGet

通用组件获取（Panic 版本）。

```go title="custom.go"
// [!code highlight]
func MustGet[T any](ctx context.Context, key xConsts.ContextKey) T
```

**读取优先级：**
1. `RegNodeKey` 聚合的节点列表
2. `ctx.Value(key)`

**说明：**
- 若传入 `*gin.Context` 会自动转换为 `c.Request.Context()`
- 未找到组件时会触发 `panic`

**示例：**

```go
// [!code highlight:3]
// 直接从 Gin 上下文获取
cache := xCtxUtil.MustGet[*xCache.Cache](c, xConsts.CacheKey)

// [!code highlight:3]
// 或者先获取标准 context
ctx := c.Request.Context()
cache := xCtxUtil.MustGet[*xCache.Cache](ctx, xConsts.CacheKey)
```

### Get

通用组件获取（错误返回版本）。

```go title="custom.go"
// [!code highlight]
func Get[T any](ctx context.Context, key xConsts.ContextKey) (T, *xError.Error)
```

**示例：**

```go
cache, err := xCtxUtil.Get[*xCache.Cache](ctx, xConsts.CacheKey)
if err != nil {
    return nil, err
}
```


### MustGetDB

从上下文获取 GORM 数据库连接（Panic 版本）。

```go title="database.go"
// [!code highlight]
func MustGetDB(ctx context.Context) *gorm.DB
```

**注意：**
- 如果上下文中未找到数据库连接，会触发 `panic`
- 返回的连接已自动绑定当前上下文（`WithContext`）

**示例：**

```go
func GetUser(ctx *gin.Context, id string) (*entity.User, error) {
    // [!code highlight]
    db := xCtxUtil.MustGetDB(ctx.Request.Context())

    var user entity.User
    if err := db.Where("id = ?", id).First(&user).Error; err != nil {
        return nil, err
    }
    return &user, nil
}
```

### GetDB

从上下文获取 GORM 数据库连接（错误返回版本）。

```go title="database.go"
// [!code highlight]
func GetDB(ctx context.Context) (*gorm.DB, *xError.Error)
```

**示例：**

```go
func GetUser(ctx *gin.Context, id string) (*entity.User, *xError.Error) {
    // [!code highlight]
    db, err := xCtxUtil.GetDB(ctx.Request.Context())
    if err != nil {
        return nil, err
    }

    var user entity.User
    if dbErr := db.Where("id = ?", id).First(&user).Error; dbErr != nil {
        return nil, xError.NewInternalServerError(ctx.Request.Context(), "查询失败", dbErr)
    }
    return &user, nil
}
```

## Redis 函数

### MustGetRDB

从上下文获取 Redis 客户端（Panic 版本）。

```go title="nosql.go"
// [!code highlight]
func MustGetRDB(ctx context.Context) *redis.Client
```

**注意：**
- 如果上下文中未找到 Redis 客户端，会触发 `panic`

**示例：**

```go
func GetCache(ctx *gin.Context, key string) (string, error) {
    // [!code highlight]
    rdb := xCtxUtil.MustGetRDB(ctx.Request.Context())

    return rdb.Get(ctx, key).Result()
}
```

### GetRDB

从上下文获取 Redis 客户端（错误返回版本）。

```go title="nosql.go"
// [!code highlight]
func GetRDB(ctx context.Context) (*redis.Client, *xError.Error)
```

**示例：**

```go
func GetCache(ctx *gin.Context, key string) (string, *xError.Error) {
    // [!code highlight]
    rdb, err := xCtxUtil.GetRDB(ctx.Request.Context())
    if err != nil {
        return "", err
    }

    val, redisErr := rdb.Get(ctx, key).Result()
    if redisErr != nil {
        return "", xError.NewError(ctx.Request.Context(), xError.CacheError, "缓存读取失败", false, redisErr)
    }
    return val, nil
}
```

## 雪花算法函数

### GetSnowflakeNode

从上下文获取雪花算法节点。

```go title="snowflake.go"
// [!code highlight]
func GetSnowflakeNode(ctx context.Context) *xSnowflake.Node
```

**说明：**
- 如果上下文中不存在节点，会**回退到默认节点**
- 确保即使在非 HTTP 请求上下文中也能正常生成 ID

**示例：**

```go
// [!code highlight]
node := xCtxUtil.GetSnowflakeNode(ctx.Request.Context())
id := node.MustGenerate()
```

### MustGenerateSnowflakeID

生成普通雪花 ID（Panic 版本）。

```go title="snowflake.go"
// [!code highlight]
func MustGenerateSnowflakeID(ctx context.Context) xSnowflake.SnowflakeID
```

**示例：**

```go
// [!code highlight]
id := xCtxUtil.MustGenerateSnowflakeID(ctx.Request.Context())
// id = 1234567890123456789
```

### GenerateSnowflakeID

生成普通雪花 ID（错误返回版本）。

```go title="snowflake.go"
// [!code highlight]
func GenerateSnowflakeID(ctx context.Context) (xSnowflake.SnowflakeID, error)
```

### MustGenerateGeneSnowflakeID

生成带业务基因的雪花 ID（Panic 版本）。

```go title="snowflake.go"
// [!code highlight]
func MustGenerateGeneSnowflakeID(ctx context.Context, gene xSnowflake.Gene) xSnowflake.SnowflakeID
```

**示例：**

```go
// [!code highlight:2]
// 生成用户 ID
userID := xCtxUtil.MustGenerateGeneSnowflakeID(ctx.Request.Context(), xSnowflake.GeneUser)

// [!code highlight:2]
// 生成订单 ID
orderID := xCtxUtil.MustGenerateGeneSnowflakeID(ctx.Request.Context(), xSnowflake.GeneOrder)
```

### GenerateGeneSnowflakeID

生成带业务基因的雪花 ID（错误返回版本）。

```go title="snowflake.go"
// [!code highlight]
func GenerateGeneSnowflakeID(ctx context.Context, gene xSnowflake.Gene) (xSnowflake.SnowflakeID, error)
```

## 函数一览

<TypeTable
  type={{
    IsDebugMode: {
      description: '判断是否处于调试模式',
      type: '() bool',
      required: true,
    },
    CalcOverheadTime: {
      description: '计算请求耗时（微秒）',
      type: '(ctx context.Context) int64',
      required: true,
    },
    GetRequestKey: {
      description: '获取请求唯一标识',
      type: '(ctx context.Context) string',
      required: true,
    },
    GetErrorMessage: {
      description: '获取错误消息',
      type: '(ctx context.Context) string',
      required: true,
    },
    MustGet: {
      description: '通用组件获取（panic）',
      type: '(ctx context.Context, key ContextKey) T',
      required: true,
    },
    Get: {
      description: '通用组件获取（错误返回）',
      type: '(ctx context.Context, key ContextKey) (T, *xError.Error)',
      required: true,
    },
    MustGetDB: {
      description: '获取数据库连接（panic）',
      type: '(ctx context.Context) *gorm.DB',
      required: true,
    },
    GetDB: {
      description: '获取数据库连接（错误返回）',
      type: '(ctx context.Context) (*gorm.DB, *xError.Error)',
      required: true,
    },
    MustGetRDB: {
      description: '获取 Redis 客户端（panic）',
      type: '(ctx context.Context) *redis.Client',
      required: true,
    },
    GetRDB: {
      description: '获取 Redis 客户端（错误返回）',
      type: '(ctx context.Context) (*redis.Client, *xError.Error)',
      required: true,
    },
    GetSnowflakeNode: {
      description: '获取雪花算法节点（带回退）',
      type: '(ctx context.Context) *xSnowflake.Node',
      required: true,
    },
    MustGenerateSnowflakeID: {
      description: '生成雪花 ID（panic）',
      type: '(ctx context.Context) SnowflakeID',
      required: true,
    },
    GenerateSnowflakeID: {
      description: '生成雪花 ID（错误返回）',
      type: '(ctx context.Context) (SnowflakeID, error)',
      required: true,
    },
    MustGenerateGeneSnowflakeID: {
      description: '生成带基因的雪花 ID（panic）',
      type: '(ctx context.Context, gene Gene) SnowflakeID',
      required: true,
    },
    GenerateGeneSnowflakeID: {
      description: '生成带基因的雪花 ID（错误返回）',
      type: '(ctx context.Context, gene Gene) (SnowflakeID, error)',
      required: true,
    },
  }}
/>

## 完整示例

```go title="service.go"
package logic

import (
    "context"

    xError "github.com/bamboo-services/bamboo-base-go/error"
    xSnowflake "github.com/bamboo-services/bamboo-base-go/snowflake"
    xCtxUtil "github.com/bamboo-services/bamboo-base-go/utility/ctxutil"
    "github.com/gin-gonic/gin"
)

func (l *UserLogic) CreateUser(c *gin.Context, username string) (*entity.User, *xError.Error) {
    // [!code highlight:2]
    // 获取标准上下文
    ctx := c.Request.Context()

    // [!code highlight:2]
    // 获取数据库连接（错误返回版本）
    db, err := xCtxUtil.GetDB(ctx)
    if err != nil {
        return nil, err
    }

    // [!code highlight:2]
    // 生成用户 ID（Panic 版本，确定雪花节点已注入）
    userID := xCtxUtil.MustGenerateGeneSnowflakeID(ctx, xSnowflake.GeneUser)

    user := &entity.User{
        Username: username,
    }
    user.ID = userID

    if dbErr := db.Create(user).Error; dbErr != nil {
        return nil, xError.NewInternalServerError(ctx, "创建用户失败", dbErr)
    }

    // [!code highlight:2]
    // 缓存用户信息（Panic 版本）
    rdb := xCtxUtil.MustGetRDB(ctx)
    rdb.Set(ctx, "user:"+userID.String(), user, time.Hour)

    return user, nil
}
```

## 迁移指南

从旧版本迁移到新版本：

| 旧版本 | 新版本 |
|--------|--------|
| `xCtxUtil.GetDB(c *gin.Context)` | `xCtxUtil.MustGetDB(c.Request.Context())` |
| `xCtxUtil.GetRDB(c *gin.Context)` | `xCtxUtil.MustGetRDB(c.Request.Context())` |
| `xCtxUtil.GetSnowflakeNode(c *gin.Context)` | `xCtxUtil.GetSnowflakeNode(c.Request.Context())` |
| `xCtxUtil.GenerateSnowflakeID(c *gin.Context)` | `xCtxUtil.MustGenerateSnowflakeID(c.Request.Context())` |
| `xCtxUtil.GenerateGeneSnowflakeID(c, gene)` | `xCtxUtil.MustGenerateGeneSnowflakeID(c.Request.Context(), gene)` |

**关键变化：**
1. 参数从 `*gin.Context` 改为 `context.Context`
2. 在 Gin Handler 中使用 `c.Request.Context()` 获取上下文
3. 新增 `Get*` 系列函数返回错误而非 panic

## 下一步

<Cards>
  <Card title="上下文键" href="/docs/bamboo-base-go/core/context/keys" />
  <Card title="概述" href="/docs/bamboo-base-go/core/context" />
</Cards>
